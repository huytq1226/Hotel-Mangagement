{% extends 'base/base.html' %}
{% load humanize %}
{% block content %}

<div class="container py-4">
    <h2 class="text-center mb-4">Xác nhận đặt phòng</h2>
    
    <div class="row">
        <!-- Thông tin phòng -->
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title blue-text">Thông tin phòng</span>
                    <div class="room-info">
                        <p><strong>Loại phòng:</strong> {{ data.room_type }}</p>
                        <p><strong>Số phòng:</strong> {{ room_no }}</p>
                        <p><strong>Quản lý:</strong> {{ roomManager }}</p>
                        <p><strong>Giá/đêm:</strong> ₫{{ data.price|floatformat:0|intcomma }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chi tiết đặt phòng -->
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title green-text">Chi tiết đặt phòng</span>
                    <form id="booking-form" method="POST" action="{% url 'book_confirm' %}">
                        {% csrf_token %}
                        
                        <!-- Ngày nhận/trả phòng -->
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">event</i>
                                <input type="text" id="new_start_date" class="datepicker" value="{{ start }}" required>
                                <label for="new_start_date">Ngày nhận phòng</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">event_available</i>
                                <input type="text" id="new_end_date" class="datepicker" value="{{ end }}" required>
                                <label for="new_end_date">Ngày trả phòng</label>
                            </div>
                        </div>

                        <!-- Thông tin thanh toán -->
                        <div class="price-details card-panel" {% if not has_dates %}style="display: none;"{% endif %}>
                            <p><strong>Số đêm:</strong> <span id="nights">{{ no_of_days }}</span></p>
                            <p><strong>Tổng tiền:</strong> ₫<span id="total_amount">{{ bill|floatformat:0 }}</span></p>
                            <p><strong>Đặt cọc (50%):</strong> ₫<span id="deposit_amount">{{ deposit|floatformat:0 }}</span></p>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="payment-section" {% if not has_dates %}style="display: none;"{% endif %}>
                            <p>
                                <label>
                                    <input name="payment_method" type="radio" value="online" checked />
                                    <span>Thanh toán online (Đặt cọc 50%)</span>
                                </label>
                            </p>
                            <div id="online-gateways" class="ml-4">
                                <p>
                                    <label>
                                        <input name="payment_gateway" type="radio" value="momo" checked />
                                        <span>MoMo</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input name="payment_gateway" type="radio" value="vnpay" />
                                        <span>VNPay</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input name="payment_gateway" type="radio" value="zalopay" />
                                        <span>ZaloPay</span>
                                    </label>
                                </p>
                            </div>
                            <p>
                                <label>
                                    <input name="payment_method" type="radio" value="offline" />
                                    <span>Thanh toán tại khách sạn</span>
                                </label>
                            </p>
                        </div>

                        <!-- Hidden inputs for form submission -->
                        <input type="hidden" name="start_date" id="start_date" value="{{ start }}">
                        <input type="hidden" name="end_date" id="end_date" value="{{ end }}">
                        <input type="hidden" name="room_price" value="{{ data.price }}">

                        <!-- Nút đặt phòng -->
                        <button class="btn waves-effect waves-light green" type="submit" {% if not has_dates %}style="display: none;"{% endif %} id="submit-button">
                            Xác nhận đặt phòng
                            <i class="material-icons right">send</i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Thêm phần đánh giá và bình luận -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title blue-text">Đánh giá từ khách hàng</span>
                    
                    <!-- Thống kê đánh giá -->
                    <div class="rating-statistics">
                        <div class="row">
                            <div class="col s12 m6">
                                {% for criteria in ratings %}
                                <div class="rating-criteria">
                                    <div class="criteria-name">{{ criteria.name }}</div>
                                    <div class="progress">
                                        <div class="determinate" style="width: {{ criteria.score }}0%"></div>
                                    </div>
                                    <div class="criteria-score">{{ criteria.score }}/10</div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col s12 m6">
                                <div class="rating-summary center-align">
                                    <h2 class="total-score">8.5</h2>
                                    <p class="rating-text">Rất tốt</p>
                                    <p class="total-reviews">Dựa trên 48 đánh giá</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phần bình luận -->
                    <div class="reviews-section">
                        <h5>Nhận xét từ khách hàng</h5>
                        <div class="review-list">
                            {% for review in reviews %}
                            <div class="review-item">
                                <div class="reviewer-info">
                                    <i class="material-icons circle">person</i>
                                    <span class="reviewer-name">{{ review.name }}</span>
                                    <span class="review-date">{{ review.date }}</span>
                                </div>
                                <div class="review-content">
                                    <p>{{ review.content }}</p>
                                </div>
                                <div class="divider"></div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.price-details {
    background: #f5f5f5;
    padding: 15px;
    margin: 15px 0;
    border-radius: 4px;
}

#online-gateways {
    margin-left: 30px;
    padding-left: 10px;
    border-left: 2px solid #e0e0e0;
}

.payment-section {
    margin: 20px 0;
}

.card {
    margin: 1rem 0;
}

/* Style cho phần rating */
.rating-criteria {
    margin: 15px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.criteria-name {
    width: 120px;
    font-size: 0.9rem;
}

.progress {
    flex-grow: 1;
    margin: 0;
    height: 8px;
    background-color: #f5f5f5;
}

.progress .determinate {
    background-color: #2196F3;
}

.criteria-score {
    width: 50px;
    text-align: right;
    font-weight: bold;
    color: #2196F3;
}

.rating-summary {
    padding: 20px;
    background: #f5f5f5;
    border-radius: 8px;
}

.total-score {
    font-size: 3rem;
    color: #2196F3;
    margin: 0;
}

.rating-text {
    font-size: 1.2rem;
    color: #4CAF50;
    margin: 5px 0;
}

.total-reviews {
    color: #757575;
    font-size: 0.9rem;
}

/* Style cho phần reviews */
.reviews-section {
    margin-top: 30px;
}

.review-item {
    margin: 20px 0;
}

.reviewer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.reviewer-info .material-icons {
    background-color: #e0e0e0;
    padding: 5px;
    border-radius: 50%;
}

.reviewer-name {
    font-weight: bold;
}

.review-date {
    color: #757575;
    font-size: 0.9rem;
}

.review-content {
    margin: 10px 0;
    color: #424242;
}

.divider {
    margin: 15px 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Khởi tạo datepicker
    var dateInputs = document.querySelectorAll('.datepicker');
    var today = new Date();
    
    var options = {
        format: 'd/mmm/yyyy',
        minDate: today,
        showClearBtn: true,
        autoClose: true,
        onSelect: updateBookingDetails,
        i18n: {
            months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            weekdays: ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'],
            weekdaysShort: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
            weekdaysAbbrev: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
            done: 'Chọn',
            clear: 'Xóa',
            cancel: 'Hủy'
        }
    };

    var instances = M.Datepicker.init(dateInputs, options);

    // Xử lý hiển thị/ẩn phương thức thanh toán online
    var paymentMethods = document.getElementsByName('payment_method');
    var onlineGateways = document.getElementById('online-gateways');

    paymentMethods.forEach(function(method) {
        method.addEventListener('change', function() {
            onlineGateways.style.display = this.value === 'online' ? 'block' : 'none';
        });
    });

    // Hàm cập nhật chi tiết đặt phòng
    function updateBookingDetails() {
        var startDate = M.Datepicker.getInstance(document.getElementById('new_start_date')).date;
        var endDate = M.Datepicker.getInstance(document.getElementById('new_end_date')).date;

        if (startDate && endDate) {
            // Tính số đêm
            var nights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            if (nights > 0) {
                // Hiện các phần thông tin đặt phòng
                document.querySelector('.price-details').style.display = 'block';
                document.querySelector('.payment-section').style.display = 'block';
                document.getElementById('submit-button').style.display = 'block';
                
                // Cập nhật hiển thị
                document.getElementById('nights').textContent = nights;
                
                // Tính tổng tiền
                var pricePerNight = parseFloat(document.querySelector('input[name="room_price"]').value);
                var totalAmount = nights * pricePerNight;
                var deposit = totalAmount * 0.5;

                document.getElementById('total_amount').textContent = totalAmount.toLocaleString();
                document.getElementById('deposit_amount').textContent = deposit.toLocaleString();

                // Cập nhật hidden inputs
                document.getElementById('start_date').value = formatDateForBackend(startDate);
                document.getElementById('end_date').value = formatDateForBackend(endDate);
            } else {
                M.toast({html: 'Ngày trả phòng phải sau ngày nhận phòng'});
            }
        }
    }

    // Hàm format ngày cho backend
    function formatDateForBackend(date) {
        var day = date.getDate();
        var month = date.toLocaleString('en-US', { month: 'short' });
        var year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // Dữ liệu mẫu cho ratings
    const ratings = [
        { name: 'Nhân viên phục vụ', score: 9 },
        { name: 'Tiện nghi', score: 8 },
        { name: 'Sạch sẽ', score: 9 },
        { name: 'Thoải mái', score: 8 },
        { name: 'Đáng giá tiền', score: 8 },
        { name: 'Địa điểm', score: 9 },
        { name: 'WiFi miễn phí', score: 8 }
    ];

    // Dữ liệu mẫu cho reviews
    const reviews = [
        {
            name: 'Nguyễn Văn A',
            date: '15/03/2024',
            content: 'Phòng sạch sẽ, gần chợ nên đi lại mua đồ cx rất tiện, nhân viên nhiệt tình gần gũi'
        },
        {
            name: 'Trần Thị B',
            date: '10/03/2024',
            content: 'Phòng sạch sẽ, vị trí dễ tìm. Chị chủ take care tốt'
        }
    ];

    // Render ratings
    const ratingsHtml = ratings.map(rating => `
        <div class="rating-criteria">
            <div class="criteria-name">${rating.name}</div>
            <div class="progress">
                <div class="determinate" style="width: ${rating.score}0%"></div>
            </div>
            <div class="criteria-score">${rating.score}/10</div>
        </div>
    `).join('');
    document.querySelector('.col.s12.m6').innerHTML = ratingsHtml;

    // Render reviews
    const reviewsHtml = reviews.map(review => `
        <div class="review-item">
            <div class="reviewer-info">
                <i class="material-icons circle">person</i>
                <span class="reviewer-name">${review.name}</span>
                <span class="review-date">${review.date}</span>
            </div>
            <div class="review-content">
                <p>${review.content}</p>
            </div>
            <div class="divider"></div>
        </div>
    `).join('');
    document.querySelector('.review-list').innerHTML = reviewsHtml;
});
</script>
{% endblock %}